---
title: "HAMR"
output: 
  flexdashboard::flex_dashboard:
    logo: img/logos_trans_black.png
    orientation: rows
    vertical_layout: fill
    css: 'styles.css'
runtime: shiny
---

```{r global, include=FALSE}

library(shiny)
library(flexdashboard)
library(leaflet)
library(dplyr)
library(dygraphs)
library(ggplot2)
library(gridExtra)
library(data.table)
library(sp)
library(rgeos)
library(datasets)
library(psych)
library(ggvis)
library(DT) # An R interface to the DataTables library
library(parallel) #Parallel detectCores() error
#devtools::install_github("KVHEM/CatCa")
# install.packages("C:/Users/Irina/ownCloud/Shared/BILAN_UPOV/bilan/bilan_2016-10-20.zip",repos=NULL, type="source")
# library(bilan)

CatCa::give_paths()

BM <- readRDS(file.path(.datadir, "webapp_data/mbilan/bilan_month.rds"))
BM.long <- readRDS(file.path(.datadir, "webapp_data/mbilan/bilan_month_long.rds"))

povodi <- readRDS(file.path(.datadir, "webapp_data/geo_rds/povodi.rds"))
reky <- readRDS(file.path(.datadir, "webapp_data/geo_rds/reky.rds"))
jezera <- readRDS(file.path(.datadir, "webapp_data/geo_rds/jezera.rds"))
nadrze <- readRDS(file.path(.datadir, "webapp_data/geo_rds/nadrze.rds"))
kraje <- readRDS(file.path(.datadir, "webapp_data/geo_rds/kraje.rds"))
okresy <- readRDS(file.path(.datadir, "webapp_data/geo_rds/okresy.rds"))
povodi_III <- readRDS(file.path(.datadir, "webapp_data/geo_rds/povodi_III.rds"))
stanice <- readRDS(file.path(.datadir, "webapp_data/geo_rds/stanice.rds"))
routing.tab <- readRDS(file.path(.datadir, "webapp_data/to_from/routing_matrix.Rds"))
cp <- readRDS(file.path(.datadir, "webapp_data/to_from/cara_prekroceni.Rds"))

popis <- readRDS(file.path(.datadir, "webapp_data/popis.rds"))

pars <- readRDS(file.path(.datadir, "webapp_data/pars/pars.rds"))
u <- readRDS(file.path(.datadir, "webapp_data/uzivani/06_16/uzivani_na_nahraz.rds"))
u_leaflet <- readRDS(file.path(.datadir, "webapp_data/uzivani/u_leaflet.rds"))
QD <- readRDS(file.path(.datadir, "webapp_data/chmu/QD.rds"))
chars <- readRDS(file.path(.datadir, "chmu/chars_mm.rds"))
spi <- readRDS(file.path(.datadir, "webapp_data/indikatory/spi.rds"))
spei <- readRDS(file.path(.datadir, "webapp_data/indikatory/spei.rds"))

# Merging data----------------
povodi <- sp::merge(povodi, popis, by='UPOV_ID')

search.choices <- as.character(povodi$UPOV_ID)
names(search.choices) <- paste(povodi$NAZ_UTVAR, search.choices, sep = ": ")

choices <- c("P" , "R", "RM", "BF", "B", "DS", "PET", "ET","SW", "SS", "GS", "INF", "PERC", "RC", "T", "H", "WEI")
names(choices) <- c(
'P - srážky na povodí [mm]',
'R - odtok (pozorovaný) [mm]',
'RM - celkovy odtok (simulovaný) [mm]',
'BF - základní odtok (simulovaný) [mm]',
'B - základní odtok (odvozený) [mm]',
'DS - zásoba pro přímý odtok [mm]',
'PET - potenciální evapotranspirace [mm]',
'ET - územní výpar [mm]',
'SW - půdní vlhkost (zásoba vody v nenasycené zóně) [mm]',
'SS - zásoba vody ve sněhu [mm]',
'GS - zásoba podzemní vody [mm]',
'INF - infiltrace do půdy [mm]',
'PERC - perkolace z půdní vrstvy [mm]',
'RC - dotace zásoby podzemní vody [mm]',
'T - teplota vzduchu [°C]',
'H - vlhkost vzduchu [%]',
'WEI - váhy pro kalibraci odtoku [-]')

choices2 <- c("P", "RM", "BF", "DS", "PET", "ET","SW")
names(choices2) <- c(
'P - srážky na povodí [mm]',
'RM - celkovy odtok (simulovaný) [mm]',
'BF - základní odtok (simulovaný) [mm]',
'DS - zásoba pro přímý odtok [mm]',
'PET - potenciální evapotranspirace [mm]',
'ET - územní výpar [mm]',
'SW - půdní vlhkost (zásoba vody v nenasycené zóně) [mm]')

choices3 <- c("value", "mean_month", "mean_year")
names(choices3) <- c("Denní průtok", "Měsiční průměr", "Roční průměr")

choices.pars <- as.character(unique(pars$name))

choices.mday <- c("Q30d", "Q60d", "Q90d", "Q120d", "Q150d", "Q180d", "Q210d", 
                  "Q240d", "Q270d", "Q300d", "Q330d", "Q355d", "Q364d")

mesice <- c("Leden","Únor","Březen","Duben","Květen","Červen",
            "Červenec","Srpen","Září","Říjen","Listopad","Prosinec")

#knitr::opts_chunk(cache.path='/home/owc/-hanel/KVHEM/-projekty/2017 SUCHO/Sucho/.ch/')
```

Základní mapa {data-icon="fa-map-o"}
===================================== 

Column {.sidebar data-width=400}
-----------------------------------------------------------------------

```{r ZM sidebar}

#Inputs--------------------

#
renderUI({
  wellPanel(
      HTML('<div class="help-tip">
           <p>Vyhledat můžete jak dle názvu, tak dle UPOV_ID.</p>
            </div>'),
      selectizeInput(inputId = "search.id","Vyhledávání útvaru",
                           selected=input$map_shape_click$id,
                           choices = search.choices)
  )
      })

wellPanel(HTML('<div class="help-tip">
               <p>Zvolte proměnnou, kterou chcete zobrazit a nastavte období.
               </p></div>'),
  selectInput("entry.variable", label="Prvky hydrologické bilance",
              choices = choices, selected = "P"), 
  
  radioButtons("kartogram", label=NULL, choices = c("Dlouhodobé průměry" = "A", 
             "Měsíční průměry" = "B", "Roční průměry" = "C"),
             selected = "A"),

  conditionalPanel(condition = "input.kartogram == 'A'",
               radioButtons("DP", label=NULL, selected = "DP1",
                                      choices = c("Celé období" = "DP1", "Volba období" = "DP2")),
                      conditionalPanel(condition = "input.DP == 'DP1'"),
                      conditionalPanel(condition = "input.DP == 'DP2'",
                                  selectInput("entry.period", label = NULL,
                                              choices = list("1961-1990" = "1", "1971-2000" = "2",
                                                            "1981 - 2010" = "3"), selected = "1")
                                  )
               ),
  conditionalPanel(condition = "input.kartogram == 'B'",
                  
                 dateInput("entry.date", label = NULL, "yyyy-mm-dd", language = "cs",
                           value = as.Date("1961-01-01"), startview = "decade",
                           min = as.Date("1961-01-01"), max = as.Date("2015-12-01"))
                 ),
  conditionalPanel(condition = "input.kartogram == 'C'",
            
                 selectInput("entry.yearC", label = "Zvolte rok:",
                             choices = seq(1961,2015,1))
                 )
  )


  renderUI({
    wellPanel(
      HTML('<div class="help-tip">
            <p>Tady nastavte rozsah hodnot.</p>
            </div>'),
      sliderInput("entry.range", label = "Filtrace dle hodnoty",
                  min = floor(reac()$def_min), 
                  max = ceiling(reac()$def_max),
                  value = c(floor(reac()$inputed_min),
                            ceiling(reac()$inputed_max)))
    )
            })

#         HTML('<button data-toggle="collapse" data-target="#box3" class="btn-block btn-primary">Filtování dle hodnoty</button>'),
#         tags$div()

actionButton("go1", "Zobrazit", icon("check"), 
    style="color: #fff; background-color: #337ab7; border-color: #2e6da4")

hr()

actionButton("reset_button", "Reset", icon("arrows"), 
    style="color: #fff; background-color: #337ab7; border-color: #2e6da4")

```

```{r ZM Reactions}

#help-------------------------
#default.shape <- function(){return("DUN_0010")}
#input<-c()
#input$entry.variable = "P"
#input$entry.year = 1968
#input$entry.month = 2
#input$entry.number = 15


#Reactions--------------------
reac<- eventReactive(input$go1,{ 

  bilance <-  BM %>% filter(variable == input$entry.variable) 
  
  bilance_filtr <- c()
  dta <- c()

#Dlouhodobé průměry (celé období/vybrané období)
  if(input$kartogram == "A"){
  if(input$DP == "DP1"){
    bilance_filtr <- bilance %>% filter(year==2000 & month==1)
    colnames(bilance_filtr)[colnames(bilance_filtr)=="value"] <- "monthly.avg"
        colnames(bilance_filtr)[colnames(bilance_filtr)=="mean_ep"] <- "value"
    dta <- (sp::merge(povodi,bilance_filtr, by="UPOV_ID"))
  }else if(input$DP == "DP2"){
        if(input$entry.period == "1"){period=seq(1961,1990,1)
        }else if(input$entry.period == "2"){period = seq(1971,2000,1) 
        }else if(input$entry.period == "3"){period = seq(1981,2010,1)}
       bilance_filtr <- bilance %>% group_by(UPOV_ID) %>% filter(year==period) %>%
       summarise(mean.period = mean(value))
       colnames(bilance_filtr)[colnames(bilance_filtr)=="value"] <- "monthly.avg"
       colnames(bilance_filtr)[colnames(bilance_filtr)=="mean.period"] <- "value"
       dta <- (sp::merge(povodi,bilance_filtr, by="UPOV_ID"))
#Měsíční průměry
  }}else if(input$kartogram == "B"){
    bilance_filtr <- bilance %>% filter(year == year(as.Date(input$entry.date)) & month==month(as.Date(input$entry.date)))
    dta <- (sp::merge(povodi,bilance_filtr, by="UPOV_ID"))
#Roční průměry
  }else if(input$kartogram == "C"){
    bilance_filtr <- bilance %>% filter(year==input$entry.yearC & month==1)
    colnames(bilance_filtr)[colnames(bilance_filtr)=="value"] <- "monthly.avg"
    colnames(bilance_filtr)[colnames(bilance_filtr)=="annual.avg"] <- "value"
    dta <- (sp::merge(povodi,bilance_filtr, by="UPOV_ID"))}
  
#Minima a maxima pro filtraci dle hodnoty  
  def_min = min(dta$value, na.rm = T)
  def_max = max(dta$value, na.rm = T)
  
  inputed_min = def_min
  inputed_max = def_max
  
  if(!is.null(input$entry.range[1])){
  if(input$entry.range[1] != def_min){
    inputed_min = input$entry.range[1]}

  if(input$entry.range[2] != def_max){
    inputed_max = input$entry.range[2]}
  }
  
  dta <- base::subset(dta, (value >= inputed_min & value <= inputed_max) | is.na(value))
  
#Vytvaření palet
  mojePaleta <- c("#f90012", "#e5734a", "#e8da89", "#b3eab3", "#3a96f2", "#0046a2")

  if(input$entry.variable == "T"){
        pal <- colorBin(mojePaleta, domain = dta$value, pretty = TRUE, reverse = TRUE,  na.color = "#ffffff")

  }else{pal <- colorBin(mojePaleta, domain = dta$value, pretty = TRUE, na.color = "#ffffff")} 
  
  
  
  return(list(bilance=bilance_filtr, dta=dta, pal = pal, inputed_min=inputed_min, inputed_max=inputed_max,
              def_min=def_min, def_max=def_max))
}, ignoreNULL = FALSE, ignoreInit = FALSE)


```

```{r loga, include=FALSE}
absolutePanel(id = "logos", fixed = TRUE,
                  draggable = FALSE, top = "auto", left = "auto", right = "auto", bottom = 10,
                  width = 400,
                  style = "opacity: 1;",
           HTML('<img src="img/logo_vuv.png" style="height:50px" hspace="10" />'),
           HTML('<img src="img/logo_fzp.jpg" style="height:50px" hspace="10" />'),
           HTML('<img src="img/logo_cgz.png" style="height:50px" hspace="10" />'),
           HTML('<img src="img/logo_chmi.png" style="height:50px" hspace="10" />'))
```

Row 
-------------------------------------


```{r ZM mapa}
#Functions--------------------

title.f <- reactive({
  title<- popis$NAZ_UTVAR[popis$UPOV_ID == default.shape()]
  return(title)
  })

default.shape <- reactive({
  UPOV_ID.sel <- input$search.id
  return(UPOV_ID.sel)})

  initial_lat = 49.7437572
  initial_lng = 15.3386383
  initial_zoom = 7



#Outputs

#Leaflet--------------------

output$map<-renderLeaflet({

    dta <- reac()$dta
    pal <- reac()$pal

  # Creating labels--------------------

    labels <- sprintf(
      "<strong>%s</strong><br/>Kategorie: %s<br/>Stav: %s <br/> UPOV_ID: %s <br/> Hodnota: %s",
      dta$NAZ_UTVAR, dta$KTG_UPOV, dta$U_PMU, dta$UPOV_ID, round(dta$value,2)
      ) %>% lapply(htmltools::HTML)


   if(length(labels)==0){labels <- c(" ")}
  
  
 leaflet() %>% 
     setView(lat = initial_lat, lng = initial_lng, zoom = initial_zoom) %>%
     addTiles(group = "Mapový podklad", options = tileOptions(minZoom=7, maxZoom=13) ) %>%
#Zbarvení povodí dle hodnoty
          addPolygons(data=dta, layerId = dta$UPOV_ID, color = "burlywood4",
                             weight = 1.3, opacity = 0.3, smoothFactor = 0,
                             fillColor = ~pal(value), fillOpacity = 0.8,
                             group = "Povodí",
                 highlightOptions = highlightOptions(color = "#a53333",
                                                     opacity = 1,
                                                     fillOpacity = 0,
                                                     weight = 2.3,
                                                     bringToFront = TRUE, sendToBack = TRUE),
                 label = labels,
                 labelOptions = labelOptions(clickable = TRUE,
                                             style = list("font-weight" = "normal",
                                             "font-family" = "sans-serif", padding = "3px 8px",
                                             keepInView = TRUE, noHide = FALSE,
                                             "border-color" = "rgb(255, 255, 255)"),
                                             textsize = "13px", direction = "auto")) %>%
#Vykreslení zakladních prvků mapy
          addPolylines(data=reky, color="#007C8C", weight = 1.5,
                 opacity = 1, stroke= TRUE, group = "Řeky") %>%
          addPolygons(data=jezera, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Jezera")%>%
          addPolygons(data=nadrze, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Nádrže")%>%
          addPolylines(data=kraje, color="#000000",  weight = 2.5, 
                       stroke= TRUE, group = "Kraje") %>%
          addPolylines(data=okresy, color="#000000",  weight = 2, 
                       stroke= TRUE, group = "Okresy") %>%
          addPolylines(data=povodi_III, color="#cc0000",  weight = 2.5, opacity = 1,
                       stroke= TRUE, group = "Povodí 3. řádu") %>%
#Legenda a ovládání vrstev mapy
      addLayersControl(overlayGroups = c("Mapový podklad", "Povodí", "Horní povodí", "Řeky", "Jezera", "Nádrže",
                                         "Kraje", "Okresy", "Povodí 3. řádu"),
                     position = "bottomleft",
                     options = layersControlOptions(collapsed = TRUE)) %>%
      hideGroup(c("Kraje", "Okresy", "Povodí 3. řádu", "Horní povodí"))%>%
      addLegend(pal = pal, values = dta$value, opacity = 0.7, title = "Legenda",
              position = "bottomright") 

    })


horni.povodi <- reactive({
      base::subset(povodi, routing.tab[povodi$UPOV_ID, (if(is.null(input$search.id)){"DUN_0010"}else{input$search.id})]==1)
  })

#Zobrazení celého horního povodí 
observe({
  leafletProxy("map") %>%
    clearGroup("Horní povodí") %>%
    addPolylines(data=horni.povodi(),
                 color = "#00264d", weight = 2.5, opacity = 0.7, stroke = TRUE,
                 group = "Horní povodí")
})

#Zvyraznění současného povodí
observe({
   leafletProxy("map") %>%
    clearGroup("current_shape") %>% 
    addPolylines(data = subset(povodi, UPOV_ID==(if(is.null(input$search.id)){"DUN_0010"}else{input$search.id})),
                 group = "current_shape",
                 color = "#a53333", opacity = 1, weight = 3,
                 stroke = TRUE) 
})

#Reset button
observe({
    input$reset_button
    leafletProxy("map") %>% setView(lat = initial_lat, lng = initial_lng, zoom = initial_zoom)})


leafletOutput("map")
  
```


Row {.tabset}
-------------------------------------

### Měsíční data

```{r cr mesicni data}

renderDygraph({
  
  ts.bilance <- BM.long %>% filter(UPOV_ID == default.shape()) %>% select(input$entry.variable2, DTM) 

  for(exp_var in input$entry.variable2){
    fit <- data.frame(lm(paste0(exp_var,"~DTM"),data=ts.bilance)$fitted)
    colnames(fit) <- paste0(exp_var,"_trend")
    ts.bilance <- cbind(ts.bilance, fit) 
  }
  
  RangeMin <- min(ts.bilance[, input$entry.variable2])-0.5
  RangeMax <- max(ts.bilance[, input$entry.variable2])+0.5
  
  ts.bilance <- xts::xts(ts.bilance, order.by = ts.bilance$DTM)

  dygraph(ts.bilance, main = paste(as.character(title.f())), xlab = "Čas") %>%
  dyAxis("y", valueRange = c(RangeMin, RangeMax)) %>%  
  dyRangeSelector() %>% 
   dyCrosshair(direction = "vertical")
})

absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE,
                  draggable = FALSE, top = '52.7%', left = "auto", right = '0.5%', bottom = "auto",
                  width = '15%',
                  style = "opacity: 0.9; style = z-index: 400",
    HTML('<button data-toggle="collapse" data-target="#box4" class="choose">Výběr časových řad</button>'),
        tags$div(id = 'box4', class="collapse", style = "max-height: 250px; overflow-y:scroll",
                 checkboxGroupInput("entry.variable2", "Zvolte:", choices = choices, selected = c("RM"))))

```

### Denní data

```{r cr denni data}
renderDygraph({
  
  d <- dir(file.path(.datadir, "bilan"))
  bilan_dir <- data.frame(source=d, UPOV_ID=gsub("*.rds","",d))
  dta_bd <- readRDS(file.path(.datadir,"bilan", bilan_dir$source[bilan_dir$UPOV_ID==default.shape()]))
  
  ts.bilance <- dta_bd %>%  select(input$entry.variable_d, DTM)
  
   for(exp_var in input$entry.variable_d){
    fit <- data.frame(lm(paste0(exp_var,"~DTM"),data=ts.bilance)$fitted)
    colnames(fit) <- paste0(exp_var,"_trend")
    ts.bilance <- cbind(ts.bilance, fit) 
  }
  
  RangeMin <- min(ts.bilance %>% select(c(input$entry.variable_d)))-0.5
  RangeMax <- max(ts.bilance %>% select(c(input$entry.variable_d)))+0.5
  
  ts.bilance <- xts::xts(ts.bilance, order.by = ts.bilance$DTM)

  dygraph(ts.bilance, main = paste(as.character(title.f())), xlab = "Čas") %>%
  dyAxis("y", valueRange = c(RangeMin, RangeMax)) %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
})

absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE,
                  draggable = FALSE, top = '52.7%', left = "auto", right = '0.5%', bottom = "auto",
                  width = '15%',
                  style = "opacity: 0.9; style = z-index: 400",
    HTML('<button data-toggle="collapse" data-target="#box6" class="choose">Výběr časových řad</button>'),
        tags$div(id = 'box6', class="collapse", style = "max-height: 250px; overflow-y:scroll",
                 checkboxGroupInput("entry.variable_d", "Zvolte:", choices = choices, selected = c("RM"))))
```

### Čára překročení

```{r cara prekroceni}

# ggvisOutput("p1")
# 
# reactive({
#   
#     cp_c <- cp %>% filter(UPOV_ID == default.shape(), variable == input$entry.variable_cp) %>% select(p_year, value)
#   
#     cp_c %>% ggvis(x = ~value, y = ~p_year) %>% layer_lines(stroke := "#00091a", strokeWidth := 2) %>%
#       add_axis("x", title = "Pravděpodobnosti") %>%
#       add_axis("x", orient = "top", ticks = 0, title = "Celé období") %>%
#       add_axis("y", title = input$variable_cp)
#     }) %>%  bind_shiny("p1")

    
    # cp_s <- cp %>% group_by(seasons) %>% filter(UPOV_ID == default.shape(), variable == input$entry.variable_cp) %>%
    #  select(p_season, value)
    # 
    # cp_s %>% ggvis(x = ~value, y = ~p_season) %>% layer_lines(stroke = ~factor(seasons) ,strokeWidth := 2.5) %>%
    #   add_axis("x", title = "Pravděpodobnosti") %>%
    #   add_axis("x", orient = "top", ticks = 0, title = "Roční období") %>%
    #   add_axis("y", title = input$variable_cp)
    # 
    # cp_m <- cp %>% group_by(month2) %>% filter(UPOV_ID == default.shape(), variable == input$entry.variable_cp) %>%
    #  select(p_month, value)
    # 
    # cp_m %>% ggvis(x = ~value, y = ~p_month) %>% layer_lines(stroke = ~factor(month2), strokeWidth := 1.5) %>%
    #   add_axis("x", title = "Pravděpodobnosti") %>%
    #   add_axis("x", orient = "top", ticks = 0, title = "Měsíce") %>%
    #   add_axis("y", title = input$variable_cp)


  # grid.arrange(cp_c,cp_s,cp_m, ncol=3)

  # ts.bilance <- ts(ts.bilance, frequency = 12, start=c(1961,1))
  # dygraph(ts.bilance, main = paste(as.character(title.f())),
  #         xlab = "Čas", ylab = paste(names(choices[choices == input$variable_cp]))) %>%
  # dySeries('value', label=input$variable_cp) %>%
  # dyRangeSelector() %>%
  # dyCrosshair(direction = "vertical")
 

absolutePanel(class = "panel panel-default", fixed = TRUE,
                  draggable = FALSE, top = '52.7%', left = "auto", right = '0.5%', bottom = "auto",
                  width = '12%',
                  style = "opacity: 1; style = z-index: 400",
    HTML('<button data-toggle="collapse" data-target="#box5" class="choose">Výběr pro čáru překročení</button>'),
        tags$div(id = 'box5', class="collapse in", style = "max-height: 420px",
                 selectInput("variable_cp", label=NULL , choices = choices, selected = c("RM"))))

```


### Trendy

```{r}

```


Indikátory sucha {data-icon="fa-tint"}
===================================== 

Column {.sidebar data-width=400}
-----------------------------------------------------------------------

```{r indikatory: sidebar}



renderUI({
  wellPanel(
      HTML('<div class="help-tip">
           <p>Vyhledat můžete jak dle názvu, tak dle UPOV_ID.</p>
            </div>'),
      selectizeInput(inputId = "search.id.ind","Vyhledávání útvaru",
                           selected=input$indikatory_shape_click$id,
                           choices = search.choices)
      )
  })

wellPanel(HTML('<div class="help-tip">
               <p>Volba indikátoru, kroku a datumu.</p></div>'),

  radioButtons("indikatory", label=NULL, choices = c("SPI" = "A","SPEI" = "B"), 
            # "PDSI" = "C", "SGI" = "D", "SRI" = "E", "Nedostatkové objemy" = "F"),
             selected = "A"),
  selectInput("krok", label = NULL, choices = c("1 měsíc" = 1, "3 měsíce" = 3,
                                                "6 měsíců" = 6, "12 měsíců" = 12), selected = 3),
  dateInput("entry.date.ind", label = NULL, "yyyy-mm-dd", language = "cs",
                           value = as.Date("1985-01-01"), startview = "decade",
                           min = as.Date("1961-01-01"), max = as.Date("2015-12-01")),
  conditionalPanel(condition = "input.indikatory == 'A'",
               selectInput("entry.variable.ind", label=NULL, selected = "P",
                                      choices = c('P', 'R', 'RM', 'BF'))
               )
  )


actionButton("go2", "Zobrazit", icon("check"), 
    style="color: #fff; background-color: #337ab7; border-color: #2e6da4")

hr()

actionButton("reset_button", "Reset", icon("arrows"), 
    style="color: #fff; background-color: #337ab7; border-color: #2e6da4")

```

```{r indikatory: Reactions}

#help-------------------------
#default.shape.ind <- function(){return("DUN_0010")}
#input<-c()
#input$entry.variable.ind = "P"
#input$krok = 3
#input$entry.date.ind <- as.Date("1961-01-01")


#Reactions--------------------
reac.ind<- eventReactive(input$go2,{ 

  spi_filter <-  spi %>% filter(variable == input$entry.variable.ind) %>% filter(scale == input$krok)
  spei_filter <- spei %>% filter(scale == input$krok)

  dta <- c()

#Dlouhodobé průměry (celé období/vybrané období)
if(input$indikatory == "A"){
    spi_d <- spi_filter %>% filter(year == year(as.Date(input$entry.date.ind)) &
                                     month==month(as.Date(input$entry.date.ind)))
    dta <- (sp::merge(povodi,spi_d, by="UPOV_ID"))}
  else{
    spei_d <- spei_filter %>% filter(year == year(as.Date(input$entry.date.ind)) &
                                          month==month(as.Date(input$entry.date.ind)))
    dta <- (sp::merge(povodi,spei_d, by="UPOV_ID"))}
  
#Vytvaření palet

# 0 - bez výskytu sucha (-0,7 a vyšší)
# 1 - slabé sucho (-0,8 až -1,3)
# 2 - silné sucho (-1,4 až -1,9)
# 3 - mimořádné sucho (- 2,0 a nižší)   
  
  mojePaleta <- c("#800000", "#ff0000", "#0066ff", "#000066")
      pal <- colorBin(mojePaleta, domain = dta$value, bins = c(Inf,-0.8, -1.4, -2, -Inf),  
                      na.color = "#ffffff")
  
  
  
  return(list(spi_filter = spi_filter, spei_filter = spei_filter, dta=dta, pal = pal))
}, ignoreNULL = FALSE, ignoreInit = FALSE)


```


Row 
-------------------------------------


```{r indikatory: mapa}
#Functions--------------------

default.shape.ind <- reactive({
  UPOV_ID.sel <- input$search.id.ind
  return(UPOV_ID.sel)})

  initial_lat = 49.7437572
  initial_lng = 15.3386383
  initial_zoom = 7



#Outputs

#Leaflet--------------------

output$indikatory<-renderLeaflet({

    dta <- reac.ind()$dta
    pal <- reac.ind()$pal

  # Creating labels--------------------

    labels <- sprintf(
      "<strong>%s</strong><br/>Kategorie: %s<br/>Stav: %s <br/> UPOV_ID: %s <br/> Hodnota: %s",
      dta$NAZ_UTVAR, dta$KTG_UPOV, dta$U_PMU, dta$UPOV_ID, round(dta$value,2)
      ) %>% lapply(htmltools::HTML)


   if(length(labels)==0){labels <- c(" ")}
  
  
 leaflet() %>% 
     setView(lat = initial_lat, lng = initial_lng, zoom = initial_zoom) %>%
     addTiles(group = "Mapový podklad", options = tileOptions(minZoom=7, maxZoom=13) ) %>%
#Zbarvení povodí dle hodnoty
          addPolygons(data=dta, layerId = dta$UPOV_ID, color = "black",
                             weight = 1.5, opacity = 0.45, smoothFactor = 0,
                             fillColor = ~pal(value), fillOpacity = 0.8,
                             group = "Povodí",
                 highlightOptions = highlightOptions(color = "#a53333",
                                                     opacity = 1,
                                                     fillOpacity = 0,
                                                     weight = 2.3,
                                                     bringToFront = TRUE, sendToBack = TRUE),
                 label = labels,
                 labelOptions = labelOptions(clickable = TRUE,
                                             style = list("font-weight" = "normal",
                                             "font-family" = "sans-serif", padding = "3px 8px",
                                             keepInView = TRUE, noHide = FALSE,
                                             "border-color" = "rgb(255, 255, 255)"),
                                             textsize = "13px", direction = "auto")) %>%
#Vykreslení zakladních prvků mapy
          addPolylines(data=reky, color="#007C8C", weight = 1.5,
                 opacity = 1, stroke= TRUE, group = "Řeky") %>%
          addPolygons(data=jezera, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Jezera")%>%
          addPolygons(data=nadrze, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Nádrže")%>%
          addPolylines(data=kraje, color="#000000",  weight = 2.5, 
                       stroke= TRUE, group = "Kraje") %>%
          addPolylines(data=okresy, color="#000000",  weight = 2, 
                       stroke= TRUE, group = "Okresy") %>%
          addPolylines(data=povodi_III, color="#cc0000",  weight = 2.5, opacity = 1,
                       stroke= TRUE, group = "Povodí 3. řádu") %>%
#Legenda a ovládání vrstev mapy
      addLayersControl(overlayGroups = c("Mapový podklad", "Povodí", "Řeky", "Jezera", "Nádrže",
                                         "Kraje", "Okresy", "Povodí 3. řádu"),
                     position = "bottomleft",
                     options = layersControlOptions(collapsed = TRUE)) %>%
      hideGroup(c("Řeky", "Jezera", "Nádrže", "Kraje", "Okresy", "Povodí 3. řádu"))%>%
      addLegend(pal = pal, values = dta$value, opacity = 0.7, title = "Legenda",
              position = "bottomright") 

    })

#Zvyraznění současného povodí
observe({
   leafletProxy("indikatory") %>%
    clearGroup("current_shape") %>% 
    addPolylines(data = subset(povodi,
                               UPOV_ID==(if(is.null(input$search.id.ind)){"HSL_1190"}else{input$search.id.ind})),
                 group = "current_shape",
                 color = "#a53333", opacity = 1, weight = 3,
                 stroke = TRUE) 
})

#Reset button
observe({
    input$reset_button
    leafletProxy("indikatory") %>% setView(lat = initial_lat, lng = initial_lng, zoom = initial_zoom)})


leafletOutput("indikatory")
  
```


Row
-------------------------------------

```{r 2 indikatory mesicni data}

renderDygraph({

  if(input$indikatory == "A"){
    ts.indikatory <- reac.ind()$spi_filter %>% filter(UPOV_ID == default.shape.ind()) %>% select(value, DTM)
}else{
    ts.indikatory <- reac.ind()$spei_filter %>% filter(UPOV_ID == default.shape.ind()) %>% select(value, DTM)
  }

RangeMin <- min(ts.indikatory$value, na.rm = T)-0.5
RangeMax <- max(ts.indikatory$value, na.rm = T)+0.5

ts.indikatory$value[is.na(ts.indikatory$value)]<-0

ts.indikatory <- xts::xts(ts.indikatory, order.by = ts.indikatory$DTM)

dygraph(ts.indikatory,
          main = paste(as.character(popis$NAZ_UTVAR[popis$UPOV_ID==default.shape.ind()])),
          xlab = "Čas") %>% 
    dyAxis("y", valueRange = c(RangeMin, RangeMax)) %>% 
    dyLimit(0, strokePattern = "solid", color = "black") %>% 
    dyOptions(colors = "gray", fillGraph = TRUE, fillAlpha = 0.4) %>% 
    dyLegend(show = "always", hideOnMouseOut = FALSE)
})

```


Uživání {data-icon="fa-circle-o"}
===================================== 

```{r uzivani: reactions}

#Reactions--------------------

povodi.ds <- reactive({
  povodi[povodi$UPOV_ID==input$search.id.u, ]
})

pal_2 <- colorFactor("Paired", domain = u_leaflet$JEV, na.color = "#ffffff")

#Functions--------------------

default.shape2 <- reactive({
  UPOV_ID.sel <- input$search.id.u
  #print(input$uzivani_shape_click$id)
  return(UPOV_ID.sel)})

title.f2 <- reactive({
  title<- popis$NAZ_UTVAR[popis$UPOV_ID == default.shape2()]
  return(title)
  })

title.f3 <- reactive({
  title <- u$NAZICO[u$NAZICO == default.circle()]
  return(title)
})

default.circle <- reactive({
  if(is.null(input$uzivani_marker_click$id)){
  NAZICO.sel <- u_leaflet$NAZICO[1]}
  else{NAZICO.sel<-input$uzivani_marker_click$id}
  return(NAZICO.sel)})

```


```{r uzivani: abs.panel}

renderUI({
    absolutePanel(class = "panel panel-default", fixed = TRUE,
                draggable = TRUE, top = '5%', left = '3.5%', right = "auto", bottom = "auto",
                width = '10%', height = '4%', style = "opacity: 1; style = z-index: 400",
          selectizeInput(inputId = "search.id.u", label = NULL,
                             selected=input$uzivani_shape_click$id, choices = search.choices))
  })

# absolutePanel(wellPanel(HTML(paste("POD - odběr z podzemních vod",
#          "POV - evidované odběry z povrchových vod",
#          "VYP - vypouštění", sep="<br/>"))))
```

Row {data-height=600}
-------------------------------------

### Mapa

```{r uzivani: mapa}



output$uzivani <- renderLeaflet({

labels.points <- sprintf(
    "<strong>%s</strong><br/>Povodí: %s<br/>Jev: %s<br/>ICOC: %s",
    u_leaflet$NAZICO, u_leaflet$POVODI, u_leaflet$JEV, u_leaflet$ICOC) %>%
    lapply(htmltools::HTML)
  

  povodif <- base::subset(povodi,UPOV_ID != input$search.id.u)

    labels <- sprintf(
      "<strong>%s</strong><br/>Kategorie: %s<br/>Stav: %s <br/> ID: %s",
      povodif$NAZ_UTVAR, povodif$KTG_UPOV, povodif$U_PMU, povodif$UPOV_ID) %>% lapply(htmltools::HTML)

  if(length(labels)==0){labels <- c(" ")}

# centr <- getSpPPolygonsLabptSlots(povodi.ds())
# leaflet() %>% setView(lng=centr[,1], lat = centr[,2], zoom=12) %>%
    
  centr <- gCentroid(povodi.ds(), byid = TRUE)
    
    leaflet() %>% setView(lng=centr@coords[1], lat = centr@coords[2], zoom=12) %>%
    addProviderTiles(providers$Esri.WorldTopoMap, group = "Mapový podklad",
                                                  options = tileOptions(minZoom=7, maxZoom=20)) %>%
    addPolylines(data=reky, color="#007C8C", weight = 1.5,
                 opacity = 1, stroke= TRUE, group = "Řeky") %>%
    addPolygons(data=jezera, color="#007C8C", fillColor = "#0099ff",
                weight = 1, opacity = 1, stroke= TRUE, group = "Jezera") %>%
    addPolygons(data=nadrze, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Nádrže") %>% 
    addLayersControl(overlayGroups = c("Mapový podklad", "Řeky", "Jezera", "Nádrže"),
                     position = "topright",
                     options = layersControlOptions(collapsed = FALSE, autoZIndex = FALSE))%>%   
    hideGroup(c("Řeky", "Jezera", "Nádrže")) %>%
    addLegend(pal = pal_2, values = u_leaflet$JEV, opacity = 0.7, title = "Legenda",
              position = "bottomright") %>% 
    addCircleMarkers(data=u_leaflet, radius = 6.5, color = "black", fillColor = pal_2(u_leaflet$JEV),
                 weight = 0.5, opacity = 0.7, fillOpacity = 1, layerId = u_leaflet$NAZICO,
                 popup = labels.points, clusterOptions = markerClusterOptions()) %>%
    addPolygons(data=povodif, color = "#000000", fillColor = "#708090", weight = 2, opacity = 0.4, smoothFactor = 0,
                layerId = povodi$UPOV_ID,
                label = labels,
                labelOptions = labelOptions(clickable = TRUE, noHide = TRUE,
                                            style = list("font-weight" = "normal",
                                                         "font-family" = "sans-serif", padding = "3px 8px",
                                                         keepInView = TRUE,
                                                         "border-color" = "#F5F5F5"),
                                            textsize = "13px", direction = "auto")
                )
})


leafletOutput("uzivani")

```

### Časová řada

```{r uzivani: casova rada}
renderDygraph({
  ts.uzivani <-  u %>% filter(UPOV_ID == default.shape2()) %>% group_by(JEV, DTM) %>%
                       summarise(sum = sum(value)) %>% ungroup %>% dcast(DTM~JEV)
  ts.uzivani <- xts::xts(ts.uzivani, order.by = ts.uzivani$DTM)
  #ts.uzivani <- ts(ts.uzivani, start = decimal_date(as.Date("2006-12-01")), frequency = 1)

  dygraph(ts.uzivani, main = paste(as.character(title.f2())))
})
```

Row {data-heigth=400}
-------------------------------------

### Suma dle odběratele

```{r uzivani: tab:odberatel}
renderDataTable({
  subtotal <- u %>% filter(UPOV_ID == default.shape2()) %>% replace(is.na(.), 0) %>% group_by(NAZICO, JEV) %>% summarise(suma = sum(value)) %>% select(NAZICO, JEV, suma)}, class = 'compact cell-border', colnames = c("Odběratel", "Jev", "Suma"), options = list(scrollY = "300px", lengthMenu = c(100,200)))
```


### Časová řada - odběratel

```{r uzivani: TS odberatel}
renderDygraph({
  ts.uzivani <-  u %>% filter(NAZICO == default.circle()) %>% group_by(JEV, DTM) %>% ungroup %>% dcast(DTM~JEV)
  ts.uzivani <- xts::xts(ts.uzivani, order.by = ts.uzivani$DTM)
  #ts.uzivani <- ts(ts.uzivani, start = decimal_date(as.Date("2006-12-01")), frequency = 1)

  dygraph(ts.uzivani, main = paste(as.character(default.circle())))
})
```


Validace {data-icon="fa-clone"}
=====================================


```{r validace: reactions}

#Functions--------------------

default.shape3 <- reactive({
  UPOV_ID.sel <- input$search.id
  return(UPOV_ID.sel)})

title.f3.1 <- reactive({
  title<- popis$NAZ_UTVAR[popis$UPOV_ID == default.shape3()]
  return(title)
  })

default.line <- reactive({
  if(is.null(input$rozvodnice_shape_click$id)){
  DBCN.sel <- QD$DBCN[1]}
  else{DBCN.sel <- input$rozvodnice_shape_click$id}
  return(DBCN.sel)})

title.f4 <- reactive({
  if(is.null(input$rozvodnice_shape_click$id)){
     title <- stanice$NAZEV_TOK[stanice$DBCN == "003000"]}else{
     title <- stanice$NAZEV_TOK[stanice$DBCN==input$rozvodnice_shape_click$id]}
  return(title)
  })

```

Column {.sidebar data-width=300}
-------------------------------------

```{r validace: sidebar}
wellPanel(
    HTML('<div class="help-tip">
          <p>Vyhledat můžete jak dle názvu, tak dle UPOV_ID.</p>
          </div>'),
          radioButtons("validace", label = NULL, choices = c("Denní průtoky" = "A", 
                                                             "Přepínání parametrů" = "B", 
                                                             "m-denní průtoky" = "C")),
          conditionalPanel(condition = "input.validace == 'A'"),
          conditionalPanel(condition = "input.validace == 'B'",
                                  selectInput("entry.pars", label=NULL,
                                              choices = choices.pars, selected = "Dgm"),
                                  renderUI({
                                    selectizeInput(inputId = "search.id","Vyhledávání útvaru",
                                          selected=input$rozvodnice_shape_click$id,
                                          choices = search.choices)})),
          conditionalPanel(condition = "input.validace == 'C'",
                                  selectInput("entry.mday", label = NULL, choices = choices.mday),
                           renderUI({
                             selectizeInput(inputId = "search.id","Vyhledávání útvaru",
                                          selected=input$rozvodnice_shape_click$id,
                                          choices = search.choices)})
                           ))
```

```{r validace: absolutePanel}
absolutePanel(class = "panel panel-default", fixed = TRUE,
                  draggable = FALSE, top = "auto", left = '1%', right = "auto", bottom = '40%',
                  width = '13%', height = "2%",
                  style = "opacity: 1; style = z-index: 400",
    HTML('<button data-toggle="collapse" data-target="#box8" class="choose">Výběr časových řad</button>'),
    tags$div(id = 'box8', class="collapse", style = "max-height: 200px; overflow-y:scroll"),
  
    conditionalPanel(condition = "input.validace == 'A'",
                     checkboxGroupInput("entry.variable4", "Zvolte:", choices = choices3, 
                                        selected = c("value"))))
```

Row {data-height = 600}
-------------------------------------

### Mapa 

```{r validace: mapa}
# input <- c()
# input$entry.mday <- "Q30d"
# input$entry.pars <- "Alf"

leafletOutput("rozvodnice")

output$rozvodnice <- renderLeaflet({
  
  if(input$validace == "A"){
  labels.lines <- sprintf(
      "<strong>%s</strong><br/> DBCN:%s <br/> Plocha [km2]: %s",
      stanice$NAZEV_TOK, stanice$DBCN, round(stanice$AREA,2)) %>% 
      lapply(htmltools::HTML)
  

  rozvodnice <- leaflet() %>%
    addTiles(group = "Mapový podklad", options = tileOptions(minZoom=7, maxZoom=13)) %>% 
    addPolylines(data=stanice, color="#CA5557", weight = 2.3, dashArray = "3",  fill = TRUE,
                 opacity = 1, stroke= TRUE, group = "Rozvodnice", layerId = stanice$DBCN,
                 highlightOptions = highlightOptions(color = "red", opacity = 1, fillOpacity = 1,
                                                     weight = 2.3,
                                                     bringToFront = TRUE, sendToBack=TRUE),
                 label = labels.lines,
                 labelOptions = labelOptions(clickable = TRUE, 
                                             style = list("font-weight" = "normal",
                                             "font-family" = "sans-serif", padding = "3px 8px",
                                             keepInView = TRUE,
                                             "border-color" = "rgb(255, 255, 255)"),
                                             textsize = "13px", direction = "auto")) %>% 
    addPolylines(data=reky, color="#007C8C", weight = 1,
                 opacity = 1, stroke= TRUE, group = "Řeky") %>% 
    addPolygons(data=jezera, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Jezera") %>%
    addPolygons(data=nadrze, color="#007C8C", fillColor = "#0099ff", 
                weight = 1, opacity = 1, stroke= TRUE, group = "Nádrže") %>%
          addPolylines(data=kraje, color="#000000",  weight = 2.5, 
                       stroke= TRUE, group = "Kraje") %>%
          addPolylines(data=okresy, color="#000000",  weight = 2, 
                       stroke= TRUE, group = "Okresy") %>%
          addPolylines(data=povodi_III, color="#cc0000",  weight = 2.5, opacity = 1,
                       stroke= TRUE, group = "Povodí 3. řádu") %>%
#Legenda a ovládání vrstev mapy
    addLayersControl(overlayGroups = c("Mapový podklad", "Řeky", "Jezera", "Nádrže", "Kraje", "Okresy", "Povodí 3. řádu"),
                     position = "bottomleft",
                     options = layersControlOptions(collapsed = TRUE, autoZIndex = FALSE))%>%   
    hideGroup(c("Kraje", "Okresy", "Povodí 3. řádu"))
  
  }else if(input$validace == "B"){
    pars_filtr <- pars %>% filter(name == input$entry.pars)
    colnames(pars_filtr)[colnames(pars_filtr) == "current"] <- "value"
    dta <- (sp::merge(povodi,pars_filtr, by="UPOV_ID"))
   
     labels <- sprintf(
     "<strong>%s</strong><br/> UPOV_ID: %s <br/> current: %s <br/> lower: %s <br/> upper: %s <br/> initial: %s",
      dta$NAZ_UTVAR , dta$UPOV_ID, round(dta$value,3), dta$lower, dta$upper, dta$initial
      ) %>% lapply(htmltools::HTML)
     pal <- colorBin("YlGnBu", domain = dta$value, pretty = TRUE)
     
     rozvodnice <- leaflet() %>% 
     setView(lat = initial_lat, lng = initial_lng, zoom = initial_zoom) %>%
     addTiles(group = "Mapový podklad", options = tileOptions(minZoom=7, maxZoom=13) )
  
    rozvodnice <- rozvodnice %>% addPolygons(data=dta, layerId = dta$UPOV_ID, 
                                             color = "burlywood4", weight = 1.3, smoothFactor = 0,
                                             opacity = 0.3, fillColor = ~pal(value), 
                                             fillOpacity = 0.8, group = "Povodí",
                                highlightOptions = highlightOptions(color = "#800000", opacity = 0.8,
                                                                    weight = 2.3,
                                                                    bringToFront = TRUE, sendToBack=TRUE),
                                label = labels,
                                labelOptions = labelOptions(clickable = TRUE, 
                                             style = list("font-weight" = "normal",
                                             "font-family" = "sans-serif", padding = "3px 8px",
                                             keepInView = TRUE, noHide = TRUE,
                                             "border-color" = "rgb(255, 255, 255)"),
                                             textsize = "15px", direction = "auto")) %>%
    addLayersControl(overlayGroups = c("Povodí","Mapový podklad"),
                     position = "bottomleft",
                     options = layersControlOptions(collapsed = TRUE, autoZIndex = FALSE)) %>%
    addLegend(pal = pal, values = dta$value, opacity = 0.7, title = "Legenda",
              position = "bottomright")
  }else{
    chars_filtr <- chars %>% select(UPOV_ID, input$entry.mday)
    colnames(chars_filtr)[colnames(chars_filtr) == input$entry.mday] <- "value"
    dta <- (sp::merge(povodi,chars_filtr, by="UPOV_ID"))
   
     labels <- sprintf(
     "<strong>%s</strong><br/>UPOV_ID: %s <br/> Hodnota: %s",
      dta$NAZ_UTVAR, dta$UPOV_ID, round(dta$value,3)) %>% lapply(htmltools::HTML)
     pal <- colorBin("YlGnBu", domain = round(dta$value,3), pretty = TRUE)
     
     rozvodnice <- leaflet() %>% 
     setView(lat = initial_lat, lng = initial_lng, zoom = initial_zoom) %>%
     addTiles(group = "Mapový podklad", options = tileOptions(minZoom=7, maxZoom=13) )
  
    rozvodnice <- rozvodnice %>% addPolygons(data=dta, layerId = dta$UPOV_ID, 
                                             color = "burlywood4", weight = 1.3, smoothFactor = 0,
                                             opacity = 0.3, fillColor = ~pal(value), 
                                             fillOpacity = 0.8, group = "Povodí",
                                highlightOptions = highlightOptions(color = "#800000", opacity = 0.8,
                                                                    weight = 2.3,
                                                                    bringToFront = TRUE, sendToBack=TRUE),
                                label = labels,
                                labelOptions = labelOptions(clickable = TRUE, 
                                             style = list("font-weight" = "normal",
                                             "font-family" = "sans-serif", padding = "3px 8px",
                                             keepInView = TRUE, noHide = TRUE,
                                             "border-color" = "rgb(255, 255, 255)"),
                                             textsize = "15px", direction = "auto")) %>%
                                addPolylines(data=kraje, color="#000000",  weight = 2.5,
                                             stroke= TRUE, group = "Kraje") %>%
                                addPolylines(data=okresy, color="#000000",  weight = 2, 
                                             stroke= TRUE, group = "Okresy") %>%
                                addPolylines(data=povodi_III, color="#cc0000",  weight = 2.5, opacity = 1,
                                             stroke= TRUE, group = "Povodí 3. řádu") %>%
                                addLayersControl(overlayGroups = c("Povodí","Mapový podklad", "Kraje",
                                                                   "Okresy", "Povodí 3. řádu"),
                     position = "bottomleft",
                     options = layersControlOptions(collapsed = TRUE, autoZIndex = FALSE)) %>%
    hideGroup(c("Kraje", "Okresy", "Povodí 3. řádu"))%>%
    addLegend(pal = pal, values = round(dta$value,2), opacity = 0.7, title = "Legenda",
              position = "bottomright")
    }
})


#   observe({
#    leafletProxy("rozvodnice") %>%
#     clearGroup("current_shape") %>% 
#     addPolylines(data = subset(povodi, UPOV_ID==(if(is.null(input$search.id)){"DUN_0010"}else{input$search.id})),
#                  group = "current_shape",
#                  color = "#a53333", opacity = 1, weight = 3,
#                  stroke = TRUE) 
# })


```

### Tabulka se základními charakteristikami {data-width=450}

```{r}
renderTable({
if(input$validace == "A"){
  QD_filter <- QD %>% filter(DBCN == default.line()) %>% select(value)
  QD_filter <-describe(QD_filter, skew = F, IQR = T, quant = c(0.5, 0.75))
  print(cbind(name="value",QD_filter[,-1]), digits=3)
}else if(input$validace == "B"){
  pars_filter <- pars %>% filter(name == input$entry.pars) %>% select(current, lower, upper, initial)
  pars_filter <- describe(pars_filter, skew = F, IQR = T, quant = c(0.5, 0.75))
  print(cbind(name=rownames(pars_filter),pars_filter[,-1]), digits=3)
} else {
  chars_filter <- chars %>% select(choices.mday)
  chars_filter <- describe(chars_filter, skew = F, IQR = T, quant = c(0.5, 0.75))
  print(cbind(name=rownames(chars_filter),chars_filter[,-1]), digits=3)
  }
})
```


Row {.tabset data-height=400}
-------------------------------------

### Denní průtoky

```{r QD: casova rada}
 
renderDygraph({
  
        ts.QD <- QD %>% filter(DBCN == default.line()) %>% mutate(month = format(DTM, "%m"), year = format(DTM, "%Y")) %>%
          group_by(year) %>% mutate(mean_year = mean(value, na.rm = TRUE)) %>% ungroup %>% group_by(month, year) %>%
          mutate(mean_month = mean(value, na.rm=TRUE)) %>% ungroup %>% select(input$entry.variable4, DTM)

        ts.QD <- xts::xts(ts.QD, order.by = ts.QD$DTM)

          dygraph(ts.QD, main = paste(as.character(title.f4())),
                xlab = "Čas", ylab = "Průtok") %>%
          dyRoller(showRoller = TRUE, rollPeriod = 1)%>%
          dyCSS("styles.css") %>%
          dyRangeSelector() %>%
          dyOptions(colors = c("green", "dark blue", "red")) %>%
          dyCrosshair(direction = "vertical")
})

```

### Parametry

```{r}

```

### m-denní průtoky

```{r}
renderPlot({
          chars_filter <- chars %>% filter(UPOV_ID == default.shape3()) %>% select(choices.mday)
          chars_filter <- data.frame(value = t(chars_filter), m = c(seq(30,330,30),355,364))
          # ts.chars <- ts(chars_filter)
          # dygraph(chars_filter) %>%
          #   dyAxis("x", label = "m dní", valueRange = chars_filter$m) %>%
          #   dyAxis("y", label = "Q", valueRange = chars_filter$value)

          plot(x = chars_filter$m, y = chars_filter$value,
               main = paste(as.character(title.f3.1())),
               type = "l", xlab = "m dní", ylab = "Q")
})
```


O projektu {data-icon="fa-user-circle"}
===================================== 

#### O projektu

Systém je založen na propojení modelu půdního (SoilClim), modelu hydrologické (Bilan) a vodohospodářské bilance. Tyto modely spolu se vstupními klimatologickými daty reprezentují sucho meteorologické, zemědělské a hydrologické.

Na vzniku systému se podílí:


<div class="col2" style="margin-top:50px">


<div class='well well-sm inst'>
  <img src="img/logo_vuv.png" style="height:50px" />

##### **Výzkumný ústav vodohospodářský T. G. Masaryka, v.v.i.**

Podbabská 30, 160 00 Praha 6

**Ing. Adam Vizina, Ph.D.**

</div>


<div class='well well-sm inst'>
  <img src="img/logo_fzp.jpg"  style="height:50px"/>


##### **Česká zemědělská univerzita v Praze, Fakulta životního prostředí**

Kamýcká 129, 165 21 Praha 6

**doc. Ing. Martin Hanel, Ph.D.**

</div>

</div>


<div class="col2" >

<div class='well well-sm inst'>
  <img src="img/logo_cgz.png" style="height:40px margin-bottom:10px" />

##### **Ústav výzkumu globální změny AV ČR, v.v.i.**

Bělidla 986/4a, 603 00 Brno

**prof. Ing. Mgr. Miroslav Trnka, Ph.D.**

</div>

<div class='well well-sm inst'>
<img src="img/logo_chmi.png" style="height:50px" />

##### **Český hydrometeorologický ústav**

Na Šabatce 2050/17, 143 06 Praha 412

**RNDr. Jan Daňhelka, Ph.D.**

</div>
</div>


<div class='well well-sm' style="background-color:white">

  <img src="img/logo_mzp.png" width="250px" />
  
Systém pro předpověď sucha vznikl v rámci projektu financovaném Ministerstvem životního prostředí v roce 2017. 

</div>
